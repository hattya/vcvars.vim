Describe #call()
  Before all
    let V = vital#vcvars#import('Prelude')

    let src = tempname() . '.c'
    let arch = has('win64') ? '64' : '32'

    let data = [
    \  '#include <stdio.h>',
    \  'void main(void) {',
    \  '#ifdef _WIN64',
    \  '  printf("%d:64", _MSC_VER);',
    \  '#else',
    \  '  printf("%d:32", _MSC_VER);',
    \  '#endif',
    \  '}',
    \]
    call writefile(data, src)
  End

  After all
    call delete(src)
  End

  Before each
    let tmp = tempname()
    let obj = tmp . '.obj'
    let exe = tmp . '.exe'
    let expr = printf('!cl /nologo "/Fo%s" "/Fe%s" /MD "%s" >NUL', obj, exe, src)
  End

  After each
    for f in V.glob(tmp . '*')
      call delete(f)
    endfor
  End

  It cannot compile
    call vcvars#call(expr, '2005', 'x86')
    silent call system(exe)
    Assert Compare(v:shell_error, '!=', 0)
  End

  It compiles with Visual Studio 2010
    if index(vcvars#list(), '10.0') == -1
      Skip requires Visual Studio 2010
    endif

    call vcvars#call(expr, '2010', 'x86')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1600:32')

    call vcvars#call(expr, '2010', 'x64')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1600:64')

    call vcvars#call(expr, '2010')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1600:' . arch)
  End

  It compiles with Visual Studio 2012
    if index(vcvars#list(), '11.0') == -1
      Skip requires Visual Studio 2012
    endif

    call vcvars#call(expr, '2012', 'x86')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1700:32')

    call vcvars#call(expr, '2012', 'x64')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1700:64')

    call vcvars#call(expr, '2012')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1700:' . arch)
  End

  It compiles with Visual Studio 2013
    if index(vcvars#list(), '12.0') == -1
      Skip requires Visual Studio 2013
    endif

    call vcvars#call(expr, '2013', 'x86')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1800:32')

    call vcvars#call(expr, '2013', 'x64')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1800:64')

    call vcvars#call(expr, '2013')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1800:' . arch)
  End

  It compiles with Visual Studio 2015
    if index(vcvars#list(), '14.0') == -1
      Skip requires Visual Studio 2015
    endif

    call vcvars#call(expr, '2015', 'x86')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1900:32')

    call vcvars#call(expr, '2015', 'x64')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1900:64')

    call vcvars#call(expr, '2015')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert Equals(out, '1900:' . arch)
  End

  It complies with Visual Studio 2017
    if index(vcvars#list(), '15.0') == -1
      Skip requires Visual Studio 2017
    endif

    call vcvars#call(expr, '2017', 'x86')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert  Match(out, '191\d:32')

    call vcvars#call(expr, '2017', 'x64')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert  Match(out, '191\d:64')

    call vcvars#call(expr, '2017')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert  Match(out, '191\d:' . arch)
  End

  It complies with Visual Studio 2019
    if index(vcvars#list(), '16.0') == -1
      Skip requires Visual Studio 2019
    endif

    call vcvars#call(expr, '2019', 'x86')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert  Match(out, '192\d:32')

    call vcvars#call(expr, '2019', 'x64')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert  Match(out, '192\d:64')

    call vcvars#call(expr, '2019')
    silent let out = system(exe)
    Assert Equals(v:shell_error, 0)
    Assert  Match(out, '192\d:' . arch)
  End
End

Describe #get()
  It returns empty dict
    Assert Equals(vcvars#get('2005', 'x86'), {})
  End

  It returns Visual Studio 2010 environment variables
    if index(vcvars#list(), '10.0') == -1
      Skip requires Visual Studio 2010
    endif

    for ver in ['10.0', '2010']
      for arch in ['x86', 'x64', 'x86-64', 'x86_64', 'amd64']
        let vars = vcvars#get(ver, arch)
        Assert IsDict(vars)
        Assert NotEmpty(vars)
        Assert NotEmpty(Where('nmake.exe', vars.path))
      endfor
      let vars = vcvars#get(ver)
      Assert IsDict(vars)
      Assert NotEmpty(vars)
      Assert NotEmpty(Where('nmake.exe', vars.path))

      Assert Equals(vcvars#get(ver, 'ia64'), {})
    endfor
  End

  It returns Visual Studio 2012 environment variables
    if index(vcvars#list(), '11.0') == -1
      Skip requires Visual Studio 2012
    endif

    for ver in ['11.0', '2012']
      for arch in ['x86', 'x64', 'x86-64', 'x86_64', 'amd64']
        let vars = vcvars#get(ver, arch)
        Assert IsDict(vars)
        Assert NotEmpty(vars)
        Assert NotEmpty(Where('nmake.exe', vars.path))
      endfor
      let vars = vcvars#get(ver)
      Assert IsDict(vars)
      Assert NotEmpty(vars)
      Assert NotEmpty(Where('nmake.exe', vars.path))

      Assert Equals(vcvars#get(ver, 'arm'), {})
    endfor
  End

  It returns Visual Studio 2013 environment variables
    if index(vcvars#list(), '12.0') == -1
      Skip requires Visual Studio 2013
    endif

    for ver in ['12.0', '2013']
      for arch in ['x86', 'x64', 'x86-64', 'x86_64', 'amd64']
        let vars = vcvars#get(ver, arch)
        Assert IsDict(vars)
        Assert NotEmpty(vars)
        Assert NotEmpty(Where('nmake.exe', vars.path))
      endfor
      let vars = vcvars#get(ver)
      Assert IsDict(vars)
      Assert NotEmpty(vars)
      Assert NotEmpty(Where('nmake.exe', vars.path))

      Assert Equals(vcvars#get(ver, 'arm'), {})
    endfor
  End

  It returns Visual Studio 2015 environment variables
    if index(vcvars#list(), '14.0') == -1
      Skip requires Visual Studio 2015
    endif

    for ver in ['14.0', '2015']
      for arch in ['x86', 'x64', 'x86-64', 'x86_64', 'amd64']
        let vars = vcvars#get(ver, arch)
        Assert IsDict(vars)
        Assert NotEmpty(vars)
        Assert NotEmpty(Where('nmake.exe', vars.path))
      endfor
      let vars = vcvars#get(ver)
      Assert IsDict(vars)
      Assert NotEmpty(vars)
      Assert NotEmpty(Where('nmake.exe', vars.path))

      Assert Equals(vcvars#get(ver, 'arm'), {})
    endfor
  End

  It returns Visual Studio 2017 environment variables
    if index(vcvars#list(), '15.0') == -1
      Skip requires Visual Studio 2017
    endif

    for ver in ['15.0', '2017']
      for arch in ['x86', 'x64', 'x86-64', 'x86_64', 'amd64']
        let vars = vcvars#get(ver, arch)
        Assert IsDict(vars)
        Assert NotEmpty(vars)
        Assert NotEmpty(Where('nmake.exe', vars.path))
      endfor
      let vars = vcvars#get(ver)
      Assert IsDict(vars)
      Assert NotEmpty(vars)
      Assert NotEmpty(Where('nmake.exe', vars.path))

      Assert Equals(vcvars#get(ver, 'arm'), {})
    endfor
  End

  It returns Visual Studio 2019 environment variables
    if index(vcvars#list(), '16.0') == -1
      Skip requires Visual Studio 2019
    endif

    for ver in ['16.0', '2019']
      for arch in ['x86', 'x64', 'x86-64', 'x86_64', 'amd64']
        let vars = vcvars#get(ver, arch)
        Assert IsDict(vars)
        Assert NotEmpty(vars)
        Assert NotEmpty(Where('nmake.exe', vars.path))
      endfor
      let vars = vcvars#get(ver)
      Assert IsDict(vars)
      Assert NotEmpty(vars)
      Assert NotEmpty(Where('nmake.exe', vars.path))

      Assert Equals(vcvars#get(ver, 'arm'), {})
    endfor
  End
End
